---

include:
  # Overriden in .rules-default but left here for reference
  - template: Workflows/MergeRequest-Pipelines.gitlab-ci.yml
  - local: .gitlab/ci/templates.yml

generate checks generators:
  extends: .generate-generators
  script:
    - .gitlab/ci/generate-checks-pipeline.sh | tee pipeline.yml

generate checks generators for forks:
  extends:
    - generate checks generators
    - .fork-default

generate images generators:
  extends: .generate-generators
  script:
    - .gitlab/ci/generate-images-pipeline.sh | tee pipeline.yml

generate images generators for forks:
  extends:
    - generate images generators
    - .fork-default

generate packages generators:
  extends: .generate-generators
  script:
    - .gitlab/ci/generate-packages-pipeline.sh | tee pipeline.yml

generate packages generators for forks:
  extends:
    - generate packages generators
    - .fork-default

trigger checks generators:
  extends: .trigger
  needs:
    - generate checks generators
  trigger:
    include:
      - job: generate checks generators
        artifact: pipeline.yml

trigger checks generators for forks:
  extends:
    - trigger checks generators
    - .rules-fork-default
  needs:
    - generate checks generators for forks
  trigger:
    include:
      - job: generate checks generators for forks
        artifact: pipeline.yml

trigger images generators:
  extends: .trigger
  needs:
    - generate images generators
  trigger:
    include:
      - job: generate images generators
        artifact: pipeline.yml

trigger images generators for forks:
  extends:
    - trigger images generators
    - .rules-fork-default
  needs:
    - generate images generators for forks
  trigger:
    include:
      - job: generate images generators for forks
        artifact: pipeline.yml

trigger packages generators:
  extends: .trigger
  needs:
    - generate packages generators
  trigger:
    include:
      - job: generate packages generators
        artifact: pipeline.yml

trigger packages generators for forks:
  extends:
    - trigger packages generators
    - .rules-fork-default
  needs:
    - generate packages generators for forks
  trigger:
    include:
      - job: generate packages generators for forks
        artifact: pipeline.yml

# Lint

show:
  extends: .qa
  script:
    - nix flake show

show for forks:
  extends:
    - show
    - .fork-default

fmt:
  extends: .qa
  script:
    - nix run .#nixpkgs-fmt -- --check $(find -name \*.nix)
  after_script:
    - nix run .#nixpkgs-fmt -- $(find -name \*.nix)
    - git diff | tee nixpkgs-fmt.diff
  artifacts:
    when: on_failure
    expose_as: "nixpkgs-fmt diff"
    paths:
      - nixpkgs-fmt.diff

fmt for forks:
  extends:
    - fmt
    - .fork-default

# Docker

nix-docker:
  extends: .docker
  needs: []
  variables:
    IMAGE: nix
